<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Allergy Symptom Tracker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide-static/0.263.1/lucide.min.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function AllergyTracker() {
      const [view, setView] = useState('log');
      const [entries, setEntries] = useState([]);
      const [loading, setLoading] = useState(true);
      
      // Form state
      const [formData, setFormData] = useState({
        date: new Date().toISOString().split('T')[0],
        symptoms: {
          sneezing: 0,
          runnyNose: 0,
          itchyEyes: 0,
          congestion: 0,
          cough: 0,
          headache: 0
        },
        weather: {
          temperature: '',
          condition: 'sunny',
          humidity: ''
        },
        pollen: {
          tree: 0,
          grass: 0,
          weed: 0,
          mold: 0
        },
        notes: ''
      });

      // Load entries from storage
      useEffect(() => {
        loadEntries();
      }, []);

      const loadEntries = async () => {
        try {
          const result = await window.storage.list('allergy-entry:');
          if (result && result.keys) {
            const loadedEntries = [];
            for (const key of result.keys) {
              try {
                const data = await window.storage.get(key);
                if (data && data.value) {
                  loadedEntries.push(JSON.parse(data.value));
                }
              } catch (e) {
                console.log(`Could not load entry ${key}`);
              }
            }
            setEntries(loadedEntries.sort((a, b) => new Date(b.date) - new Date(a.date)));
          }
        } catch (error) {
          console.log('No existing entries found');
        } finally {
          setLoading(false);
        }
      };

      const saveEntry = async () => {
        const entry = {
          ...formData,
          id: `${formData.date}-${Date.now()}`
        };

        try {
          await window.storage.set(`allergy-entry:${entry.id}`, JSON.stringify(entry));
          setEntries(prev => [entry, ...prev.filter(e => e.id !== entry.id)].sort((a, b) => 
            new Date(b.date) - new Date(a.date)
          ));
          
          // Reset form
          setFormData({
            date: new Date().toISOString().split('T')[0],
            symptoms: {
              sneezing: 0,
              runnyNose: 0,
              itchyEyes: 0,
              congestion: 0,
              cough: 0,
              headache: 0
            },
            weather: {
              temperature: '',
              condition: 'sunny',
              humidity: ''
            },
            pollen: {
              tree: 0,
              grass: 0,
              weed: 0,
              mold: 0
            },
            notes: ''
          });
          
          setView('history');
        } catch (error) {
          alert('Failed to save entry. Please try again.');
        }
      };

      const deleteEntry = async (entryId) => {
        if (!confirm('Are you sure you want to delete this entry?')) return;
        
        try {
          await window.storage.delete(`allergy-entry:${entryId}`);
          setEntries(prev => prev.filter(e => e.id !== entryId));
        } catch (error) {
          alert('Failed to delete entry.');
        }
      };

      const updateSymptom = (symptom, value) => {
        setFormData(prev => ({
          ...prev,
          symptoms: { ...prev.symptoms, [symptom]: parseInt(value) }
        }));
      };

      const updatePollen = (type, value) => {
        setFormData(prev => ({
          ...prev,
          pollen: { ...prev.pollen, [type]: parseInt(value) }
        }));
      };

      const updateWeather = (field, value) => {
        setFormData(prev => ({
          ...prev,
          weather: { ...prev.weather, [field]: value }
        }));
      };

      const getSeverityColor = (value) => {
        if (value === 0) return 'bg-gray-200';
        if (value === 1) return 'bg-green-200';
        if (value === 2) return 'bg-yellow-200';
        if (value === 3) return 'bg-orange-200';
        return 'bg-red-200';
      };

      const getSeverityLabel = (value) => {
        const labels = ['None', 'Mild', 'Moderate', 'Severe', 'Very Severe'];
        return labels[value] || 'None';
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center min-h-screen">
            <div className="text-xl text-gray-600">Loading...</div>
          </div>
        );
      }

      return (
        <div className="max-w-4xl mx-auto p-6">
          <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
            {/* Header */}
            <div className="bg-gradient-to-r from-blue-500 to-green-500 p-6 text-white">
              <h1 className="text-3xl font-bold mb-2">üå∏ Allergy Symptom Tracker</h1>
              <p className="text-blue-100">Track your symptoms, weather, and pollen levels</p>
            </div>

            {/* Navigation */}
            <div className="flex border-b">
              <button
                onClick={() => setView('log')}
                className={`flex-1 py-4 font-semibold transition-colors ${
                  view === 'log' 
                    ? 'bg-blue-50 text-blue-600 border-b-2 border-blue-600' 
                    : 'text-gray-600 hover:bg-gray-50'
                }`}
              >
                üìù Log Entry
              </button>
              <button
                onClick={() => setView('history')}
                className={`flex-1 py-4 font-semibold transition-colors ${
                  view === 'history' 
                    ? 'bg-blue-50 text-blue-600 border-b-2 border-blue-600' 
                    : 'text-gray-600 hover:bg-gray-50'
                }`}
              >
                üìä History ({entries.length})
              </button>
            </div>

            {/* Content */}
            <div className="p-6">
              {view === 'log' ? (
                <div className="space-y-6">
                  {/* Date */}
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                    <input
                      type="date"
                      value={formData.date}
                      onChange={(e) => setFormData(prev => ({ ...prev, date: e.target.value }))}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>

                  {/* Symptoms */}
                  <div>
                    <h3 className="text-lg font-bold text-gray-800 mb-3">Symptoms</h3>
                    <div className="space-y-4">
                      {Object.entries(formData.symptoms).map(([key, value]) => (
                        <div key={key}>
                          <div className="flex justify-between mb-1">
                            <label className="text-sm font-medium text-gray-700 capitalize">
                              {key.replace(/([A-Z])/g, ' $1').trim()}
                            </label>
                            <span className={`text-sm font-semibold px-3 py-1 rounded-full ${getSeverityColor(value)}`}>
                              {getSeverityLabel(value)}
                            </span>
                          </div>
                          <input
                            type="range"
                            min="0"
                            max="4"
                            value={value}
                            onChange={(e) => updateSymptom(key, e.target.value)}
                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                          />
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Weather */}
                  <div>
                    <h3 className="text-lg font-bold text-gray-800 mb-3">Weather</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Temperature (¬∞F)</label>
                        <input
                          type="number"
                          value={formData.weather.temperature}
                          onChange={(e) => updateWeather('temperature', e.target.value)}
                          placeholder="72"
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Condition</label>
                        <select
                          value={formData.weather.condition}
                          onChange={(e) => updateWeather('condition', e.target.value)}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                          <option value="sunny">‚òÄÔ∏è Sunny</option>
                          <option value="cloudy">‚òÅÔ∏è Cloudy</option>
                          <option value="rainy">üåßÔ∏è Rainy</option>
                          <option value="windy">üí® Windy</option>
                          <option value="snowy">‚ùÑÔ∏è Snowy</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Humidity (%)</label>
                        <input
                          type="number"
                          value={formData.weather.humidity}
                          onChange={(e) => updateWeather('humidity', e.target.value)}
                          placeholder="65"
                          min="0"
                          max="100"
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>
                    </div>
                  </div>

                  {/* Pollen */}
                  <div>
                    <h3 className="text-lg font-bold text-gray-800 mb-3">Pollen Levels</h3>
                    <div className="space-y-4">
                      {Object.entries(formData.pollen).map(([key, value]) => (
                        <div key={key}>
                          <div className="flex justify-between mb-1">
                            <label className="text-sm font-medium text-gray-700 capitalize">
                              {key} Pollen
                            </label>
                            <span className={`text-sm font-semibold px-3 py-1 rounded-full ${getSeverityColor(value)}`}>
                              {getSeverityLabel(value)}
                            </span>
                          </div>
                          <input
                            type="range"
                            min="0"
                            max="4"
                            value={value}
                            onChange={(e) => updatePollen(key, e.target.value)}
                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                          />
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Notes */}
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
                    <textarea
                      value={formData.notes}
                      onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
                      placeholder="Any additional observations..."
                      rows="3"
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>

                  {/* Save Button */}
                  <button
                    onClick={saveEntry}
                    className="w-full bg-gradient-to-r from-blue-500 to-green-500 text-white font-bold py-3 px-6 rounded-lg hover:from-blue-600 hover:to-green-600 transition-all shadow-lg"
                  >
                    üíæ Save Entry
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  {entries.length === 0 ? (
                    <div className="text-center py-12">
                      <p className="text-gray-500 text-lg mb-4">No entries yet</p>
                      <button
                        onClick={() => setView('log')}
                        className="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors"
                      >
                        Create First Entry
                      </button>
                    </div>
                  ) : (
                    entries.map(entry => (
                      <div key={entry.id} className="bg-gray-50 rounded-lg p-5 border border-gray-200">
                        <div className="flex justify-between items-start mb-4">
                          <div>
                            <h4 className="font-bold text-lg text-gray-800">
                              {new Date(entry.date).toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                              })}
                            </h4>
                            <div className="text-sm text-gray-600 mt-1">
                              {entry.weather.temperature && `${entry.weather.temperature}¬∞F`}
                              {entry.weather.temperature && entry.weather.condition && ' ‚Ä¢ '}
                              {entry.weather.condition && entry.weather.condition.charAt(0).toUpperCase() + entry.weather.condition.slice(1)}
                              {entry.weather.humidity && ` ‚Ä¢ ${entry.weather.humidity}% humidity`}
                            </div>
                          </div>
                          <button
                            onClick={() => deleteEntry(entry.id)}
                            className="text-red-500 hover:text-red-700 font-semibold text-sm"
                          >
                            üóëÔ∏è Delete
                          </button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <h5 className="font-semibold text-gray-700 mb-2 text-sm">Symptoms</h5>
                            <div className="space-y-1">
                              {Object.entries(entry.symptoms).map(([key, value]) => (
                                value > 0 && (
                                  <div key={key} className="flex justify-between text-sm">
                                    <span className="capitalize text-gray-600">
                                      {key.replace(/([A-Z])/g, ' $1').trim()}
                                    </span>
                                    <span className={`font-semibold px-2 py-0.5 rounded ${getSeverityColor(value)}`}>
                                      {getSeverityLabel(value)}
                                    </span>
                                  </div>
                                )
                              ))}
                            </div>
                          </div>

                          <div>
                            <h5 className="font-semibold text-gray-700 mb-2 text-sm">Pollen Levels</h5>
                            <div className="space-y-1">
                              {Object.entries(entry.pollen).map(([key, value]) => (
                                value > 0 && (
                                  <div key={key} className="flex justify-between text-sm">
                                    <span className="capitalize text-gray-600">{key}</span>
                                    <span className={`font-semibold px-2 py-0.5 rounded ${getSeverityColor(value)}`}>
                                      {getSeverityLabel(value)}
                                    </span>
                                  </div>
                                )
                              ))}
                            </div>
                          </div>
                        </div>

                        {entry.notes && (
                          <div className="mt-3 pt-3 border-t border-gray-300">
                            <p className="text-sm text-gray-700 italic">"{entry.notes}"</p>
                          </div>
                        )}
                      </div>
                    ))
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<AllergyTracker />, document.getElementById('root'));
  </script>
</body>
</html>
