<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Allergy Symptom Tracker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    // REPLACE THESE with your own Firebase config from Firebase Console
    // Get these values from: Firebase Console > Project Settings > Your apps > Web app
    const firebaseConfig = {
      apiKey: "AIzaSyBKDmUQIH4liJGo6nZnUMWTVNw_PtZpgG8",
      authDomain: "allergy-tracker-8325a.firebaseapp.com",
      projectId: "allergy-tracker-8325a",
      storageBucket: "allergy-tracker-8325a.firebasestorage.app",
      messagingSenderId: "768176741527",
      appId: "1:768176741527:web:1de06a2df5f92a0ea71dd2",
      measurementId: "G-Y95CH004YH"
    };

    // Initialize Firebase (only if config is set)
    let db = null;
    let auth = null;
    let firebaseEnabled = false;

    try {
      if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        auth = firebase.auth();
        firebaseEnabled = true;
        console.log("‚úÖ Firebase enabled - cross-device sync active!");
      } else {
        console.log("‚ö†Ô∏è Firebase not configured - using localStorage only");
      }
    } catch (error) {
      console.log("Firebase initialization error, using localStorage:", error);
    }

    // ============================================
    // STORAGE ABSTRACTION LAYER
    // Automatically uses Firebase when available, falls back to localStorage
    // ============================================
    const storage = {
      async get(key, shared = false) {
        if (firebaseEnabled && shared) {
          try {
            const user = auth.currentUser;
            if (!user) return undefined;
            
            const doc = await db.collection('users').doc(user.uid).collection('data').doc(key).get();
            if (doc.exists) {
              return { value: doc.data().value };
            }
            return undefined;
          } catch (e) {
            console.error('Firebase get error', e);
            throw e;
          }
        } else {
          try {
            const v = localStorage.getItem(key);
            if (v === null) return undefined;
            return { value: v };
          } catch (e) {
            console.error('localStorage.get error', e);
            throw e;
          }
        }
      },

      async set(key, value, shared = false) {
        if (firebaseEnabled && shared) {
          try {
            const user = auth.currentUser;
            if (!user) throw new Error('Not authenticated');
            
            await db.collection('users').doc(user.uid).collection('data').doc(key).set({
              value: value,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            return { success: true };
          } catch (e) {
            console.error('Firebase set error', e);
            throw e;
          }
        } else {
          try {
            localStorage.setItem(key, value);
            return { success: true };
          } catch (e) {
            console.error('localStorage.set error', e);
            throw e;
          }
        }
      },

      async delete(key, shared = false) {
        if (firebaseEnabled && shared) {
          try {
            const user = auth.currentUser;
            if (!user) throw new Error('Not authenticated');
            
            await db.collection('users').doc(user.uid).collection('data').doc(key).delete();
            return { success: true };
          } catch (e) {
            console.error('Firebase delete error', e);
            throw e;
          }
        } else {
          try {
            localStorage.removeItem(key);
            return { success: true };
          } catch (e) {
            console.error('localStorage.delete error', e);
            throw e;
          }
        }
      },

      async list(prefix, shared = false) {
        if (firebaseEnabled && shared) {
          try {
            const user = auth.currentUser;
            if (!user) return { keys: [] };
            
            const snapshot = await db.collection('users').doc(user.uid).collection('data').get();
            const keys = snapshot.docs
              .map(doc => doc.id)
              .filter(key => key.startsWith(prefix));
            return { keys };
          } catch (e) {
            console.error('Firebase list error', e);
            throw e;
          }
        } else {
          try {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
              const k = localStorage.key(i);
              if (k && k.startsWith(prefix)) keys.push(k);
            }
            return { keys };
          } catch (e) {
            console.error('localStorage.list error', e);
            throw e;
          }
        }
      }
    };

    function AllergyTracker() {
      // Helper function to get today's date in local timezone as YYYY-MM-DD
      const getTodayLocal = () => {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      const [view, setView] = useState('log');
      const [entries, setEntries] = useState([]);
      const [loading, setLoading] = useState(true);
      const [fetchingWeather, setFetchingWeather] = useState(false);
      const [fetchingPollen, setFetchingPollen] = useState(false);
      const [apiKeys, setApiKeys] = useState({ weather: '', pollen: '' });
      const [showApiSetup, setShowApiSetup] = useState(false);
      const [user, setUser] = useState(null);
      const [signingIn, setSigningIn] = useState(false);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [isSignUp, setIsSignUp] = useState(false);
      const [autoFetchStatus, setAutoFetchStatus] = useState({ 
        weather: { type: null, timestamp: null }, 
        pollen: { type: null, timestamp: null } 
      });
      
      // Form state
      const [formData, setFormData] = useState({
        date: getTodayLocal(),
        location: {
          latitude: null,
          longitude: null,
          city: '',
          state: '',
          display: '' // Human-readable location
        },
        symptoms: {
          sneezing: 0,
          runnyNose: 0,
          itchyEyes: 0,
          congestion: 0,
          cough: 0,
          headache: 0
        },
        weather: {
          temperature: '',
          condition: 'sunny',
          humidity: ''
        },
        pollen: {
          // Tree pollens
          alder: 0,
          birch: 0,
          cypress: 0,
          elm: 0,
          hazel: 0,
          oak: 0,
          pine: 0,
          plane: 0,
          poplar: 0,
          // Grass pollen
          grass: 0,
          // Weed pollens
          mugwort: 0,
          ragweed: 0,
          // Other
          mold: 0
        },
        notes: ''
      });

      // Load entries and API keys from storage
      useEffect(() => {
        if (firebaseEnabled) {
          const unsubscribe = auth.onAuthStateChanged((user) => {
            setUser(user);
            if (user) {
              loadEntries();
              loadApiKeys();
            } else {
              setLoading(false);
            }
          });
          return () => unsubscribe();
        } else {
          loadEntries();
          loadApiKeys();
        }
      }, []);

      // Auto-fetch weather and pollen when API keys are available
      useEffect(() => {
        if (apiKeys.weather || apiKeys.pollen) {
          const autoFetch = async () => {
            // Wait a bit for the component to be ready
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (apiKeys.weather && !formData.weather.temperature && !autoFetchStatus.weather.type) {
              await fetchWeatherData(true);
            }
            if (apiKeys.pollen && !autoFetchStatus.pollen.type) {
              // Check if pollen data hasn't been fetched yet (all values are 0)
              const hasPollenData = Object.values(formData.pollen).some(v => v > 0);
              if (!hasPollenData) {
                await fetchPollenData(true);
              }
            }
          };
          
          autoFetch();
        }
      }, [apiKeys]);

      // Auto-refresh timestamp display every minute
      useEffect(() => {
        const interval = setInterval(() => {
          // Force re-render to update "X mins ago" display
          setAutoFetchStatus(prev => ({ ...prev }));
        }, 60000); // Update every minute
        
        return () => clearInterval(interval);
      }, []);

      const signInWithEmail = async () => {
        if (!firebaseEnabled) {
          alert('Firebase is not configured.');
          return;
        }
        
        if (!email || !password) {
          alert('Please enter both email and password');
          return;
        }
        
        setSigningIn(true);
        try {
          if (isSignUp) {
            // Create new account
            await auth.createUserWithEmailAndPassword(email, password);
            alert('‚úÖ Account created! Your data will sync across all devices.');
          } else {
            // Sign in to existing account
            await auth.signInWithEmailAndPassword(email, password);
            alert('‚úÖ Signed in! Loading your data...');
          }
        } catch (error) {
          if (error.code === 'auth/email-already-in-use') {
            alert('Email already in use. Try signing in instead.');
          } else if (error.code === 'auth/user-not-found') {
            alert('No account found. Try signing up instead.');
          } else if (error.code === 'auth/wrong-password') {
            alert('Incorrect password.');
          } else if (error.code === 'auth/invalid-email') {
            alert('Invalid email address.');
          } else if (error.code === 'auth/weak-password') {
            alert('Password should be at least 6 characters.');
          } else {
            alert('Error: ' + error.message);
          }
        } finally {
          setSigningIn(false);
        }
      };

      const signOut = async () => {
        if (firebaseEnabled && confirm('Sign out? Your data will still be saved in the cloud.')) {
          await auth.signOut();
          setEntries([]);
          setApiKeys({ weather: '', pollen: '' });
        }
      };

      const loadApiKeys = async () => {
        try {
          // Load from global settings instead of per-user
          if (firebaseEnabled) {
            const weatherDoc = await db.collection('settings').doc('api-keys').get();
            if (weatherDoc.exists) {
              const keys = weatherDoc.data();
              setApiKeys({
                weather: keys.weather || '',
                pollen: keys.pollen || ''
              });
            }
          } else {
            const weatherKey = await storage.get('api-key-weather', false);
            const pollenKey = await storage.get('api-key-pollen', false);
            setApiKeys({
              weather: weatherKey?.value || '',
              pollen: pollenKey?.value || ''
            });
          }
        } catch (error) {
          console.log('No API keys saved yet');
        }
      };

      const saveApiKeys = async () => {
        try {
          // Save to global settings so all users can use the same API keys
          if (firebaseEnabled) {
            await db.collection('settings').doc('api-keys').set({
              weather: apiKeys.weather || '',
              pollen: apiKeys.pollen || '',
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } else {
            if (apiKeys.weather) {
              await storage.set('api-key-weather', apiKeys.weather, false);
            } else {
              try { await storage.delete('api-key-weather', false); } catch (e) { /* ignore */ }
            }

            if (apiKeys.pollen) {
              await storage.set('api-key-pollen', apiKeys.pollen, false);
            } else {
              try { await storage.delete('api-key-pollen', false); } catch (e) { /* ignore */ }
            }
          }

          setShowApiSetup(false);
          alert('API keys saved and shared with all users!');
        } catch (error) {
          console.error('Failed to save API keys', error);
          alert('Failed to save API keys: ' + (error?.message || error));
        }
      };

      const loadEntries = async () => {
        try {
          const result = await storage.list('allergy-entry:', true);
          if (result && result.keys) {
            const loadedEntries = [];
            for (const key of result.keys) {
              try {
                const data = await storage.get(key, true);
                if (data && data.value) {
                  loadedEntries.push(JSON.parse(data.value));
                }
              } catch (e) {
                console.log(`Could not load entry ${key}`);
              }
            }
            setEntries(loadedEntries.sort((a, b) => new Date(b.date) - new Date(a.date)));
          }
        } catch (error) {
          console.log('No existing entries found');
        } finally {
          setLoading(false);
        }
      };

      const fetchWeatherData = async (isAuto = false) => {
        setFetchingWeather(true);
        try {
          // Get user's location
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
          });
          
          const { latitude, longitude } = position.coords;
          
          if (!apiKeys.weather) {
            if (!isAuto) alert('Please set up your OpenWeatherMap API key first. Click "API Setup" to add it.');
            setFetchingWeather(false);
            return;
          }
          
          // Fetch location name using reverse geocoding (free, no API key needed)
          let locationDisplay = `${latitude.toFixed(2)}, ${longitude.toFixed(2)}`;
          let city = '';
          let state = '';
          
          try {
            const geoResponse = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`
            );
            const geoData = await geoResponse.json();
            
            if (geoData.address) {
              city = geoData.address.city || geoData.address.town || geoData.address.village || '';
              state = geoData.address.state || '';
              
              if (city && state) {
                locationDisplay = `${city}, ${state}`;
              } else if (city) {
                locationDisplay = city;
              } else if (state) {
                locationDisplay = state;
              }
            }
          } catch (e) {
            console.log('Could not get location name:', e);
          }
          
          // Fetch from OpenWeatherMap
          const response = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${apiKeys.weather}&units=imperial`
          );
          
          if (!response.ok) {
            throw new Error('Weather API request failed. Please check your API key.');
          }
          
          const data = await response.json();
          
          // Map weather condition to our options
          const conditionMap = {
            'Clear': 'sunny',
            'Clouds': 'cloudy',
            'Rain': 'rainy',
            'Drizzle': 'rainy',
            'Thunderstorm': 'rainy',
            'Snow': 'snowy',
            'Mist': 'cloudy',
            'Smoke': 'cloudy',
            'Haze': 'cloudy',
            'Dust': 'windy',
            'Fog': 'cloudy',
            'Sand': 'windy',
            'Ash': 'cloudy',
            'Squall': 'windy',
            'Tornado': 'windy'
          };
          
          setFormData(prev => ({
            ...prev,
            location: {
              latitude,
              longitude,
              city,
              state,
              display: locationDisplay
            },
            weather: {
              temperature: Math.round(data.main.temp).toString(),
              condition: conditionMap[data.weather[0].main] || 'sunny',
              humidity: data.main.humidity.toString()
            }
          }));
          
          setAutoFetchStatus(prev => ({ 
            ...prev, 
            weather: { type: isAuto ? 'auto' : 'manual', timestamp: new Date() }
          }));
          
          if (!isAuto) alert('Weather data fetched successfully!');
        } catch (error) {
          if (!isAuto) {
            if (error.message.includes('User denied')) {
              alert('Location access denied. Please enable location or enter weather manually.');
            } else {
              alert(`Failed to fetch weather: ${error.message}`);
            }
          }
        } finally {
          setFetchingWeather(false);
        }
      };

      const fetchPollenData = async (isAuto = false) => {
        setFetchingPollen(true);
        try {
          // Get user's location
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
          });
          
          const { latitude, longitude } = position.coords;
          
          if (!apiKeys.pollen) {
            if (!isAuto) alert('Please set up your Google Pollen API key first. Click "API Setup" to add it.');
            setFetchingPollen(false);
            return;
          }
          
          // Fetch location name using reverse geocoding
          let locationDisplay = `${latitude.toFixed(2)}, ${longitude.toFixed(2)}`;
          let city = '';
          let state = '';
          
          try {
            const geoResponse = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`
            );
            const geoData = await geoResponse.json();
            
            if (geoData.address) {
              city = geoData.address.city || geoData.address.town || geoData.address.village || '';
              state = geoData.address.state || '';
              
              if (city && state) {
                locationDisplay = `${city}, ${state}`;
              } else if (city) {
                locationDisplay = city;
              } else if (state) {
                locationDisplay = state;
              }
            }
          } catch (e) {
            console.log('Could not get location name:', e);
          }
          
          // Using Google Pollen API
          const response = await fetch(
            `https://pollen.googleapis.com/v1/forecast:lookup?key=${apiKeys.pollen}&location.latitude=${latitude}&location.longitude=${longitude}&days=1&plantsDescription=true`
          );
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'Pollen API request failed. Please check your API key.');
          }
          
          const data = await response.json();
          
          // Extract specific pollen data from Google's response
          // Google UPI scale is 0-5, we convert to 0-4
          const convertUPI = (upi) => Math.min(4, Math.round(upi * 0.8));
          
          const pollenData = {
            alder: 0, birch: 0, cypress: 0, elm: 0, hazel: 0,
            oak: 0, pine: 0, plane: 0, poplar: 0,
            grass: 0,
            mugwort: 0, ragweed: 0,
            mold: 0
          };
          
          if (data.dailyInfo && data.dailyInfo[0]) {
            const dayInfo = data.dailyInfo[0];
            
            // Get main pollen type info
            if (dayInfo.pollenTypeInfo) {
              dayInfo.pollenTypeInfo.forEach(pollen => {
                const value = pollen.indexInfo?.value || 0;
                
                if (pollen.code === 'GRASS') {
                  pollenData.grass = convertUPI(value);
                }
                
                // Check for specific plant types in plantInfo
                if (pollen.plantInfo) {
                  pollen.plantInfo.forEach(plant => {
                    const plantValue = plant.indexInfo?.value || value; // Use specific plant value if available
                    const converted = convertUPI(plantValue);
                    
                    // Map plant codes to our fields
                    const plantCode = plant.code?.toLowerCase();
                    if (plantCode === 'alder') pollenData.alder = converted;
                    else if (plantCode === 'birch') pollenData.birch = converted;
                    else if (plantCode === 'cypress') pollenData.cypress = converted;
                    else if (plantCode === 'elm') pollenData.elm = converted;
                    else if (plantCode === 'hazel') pollenData.hazel = converted;
                    else if (plantCode === 'oak') pollenData.oak = converted;
                    else if (plantCode === 'pine') pollenData.pine = converted;
                    else if (plantCode === 'plane') pollenData.plane = converted;
                    else if (plantCode === 'poplar' || plantCode === 'cottonwood') pollenData.poplar = converted;
                    else if (plantCode === 'mugwort') pollenData.mugwort = converted;
                    else if (plantCode === 'ragweed') pollenData.ragweed = converted;
                  });
                }
              });
            }
          }
          
          setFormData(prev => ({
            ...prev,
            location: {
              latitude,
              longitude,
              city,
              state,
              display: locationDisplay
            },
            pollen: pollenData
          }));
          
          setAutoFetchStatus(prev => ({ 
            ...prev, 
            pollen: { type: isAuto ? 'auto' : 'manual', timestamp: new Date() }
          }));
          
          if (!isAuto) alert('Pollen data fetched successfully!');
        } catch (error) {
          if (!isAuto) {
            if (error.message.includes('User denied')) {
              alert('Location access denied. Please enable location or enter pollen levels manually.');
            } else {
              alert(`Failed to fetch pollen data: ${error.message}`);
            }
          }
        } finally {
          setFetchingPollen(false);
        }
      };

      const saveEntry = async () => {
        const entry = {
          ...formData,
          id: `${formData.date}-${Date.now()}`
        };

        try {
          // Delete any existing entries for this date
          const existingEntries = entries.filter(e => e.date === formData.date);
          for (const oldEntry of existingEntries) {
            try {
              await storage.delete(`allergy-entry:${oldEntry.id}`, true);
            } catch (e) {
              console.log('Could not delete old entry:', e);
            }
          }

          // Save new entry
          await storage.set(`allergy-entry:${entry.id}`, JSON.stringify(entry), true);
          
          // Update local state - remove old entries for this date and add new one
          setEntries(prev => [entry, ...prev.filter(e => e.date !== formData.date)].sort((a, b) => 
            new Date(b.date) - new Date(a.date)
          ));
          
          // Reset form - keep weather, pollen, and location data, only reset symptoms
          setFormData(prev => ({
            date: getTodayLocal(),
            location: prev.location, // Keep location
            symptoms: {
              sneezing: 0,
              runnyNose: 0,
              itchyEyes: 0,
              congestion: 0,
              cough: 0,
              headache: 0
            },
            weather: prev.weather, // Keep weather data
            pollen: prev.pollen, // Keep pollen data
            notes: ''
          }));
          
          // Don't reset autoFetchStatus so indicators remain
          setView('history');
        } catch (error) {
          alert('Failed to save entry. Please try again.');
        }
      };

      const deleteEntry = async (entryId) => {
        if (!confirm('Are you sure you want to delete this entry?')) return;
        
        try {
          await storage.delete(`allergy-entry:${entryId}`, true);
          setEntries(prev => prev.filter(e => e.id !== entryId));
        } catch (error) {
          alert('Failed to delete entry.');
        }
      };

      const updateSymptom = (symptom, value) => {
        setFormData(prev => ({
          ...prev,
          symptoms: { ...prev.symptoms, [symptom]: parseInt(value) }
        }));
      };

      const updatePollen = (type, value) => {
        setFormData(prev => ({
          ...prev,
          pollen: { ...prev.pollen, [type]: parseInt(value) }
        }));
      };

      const updateWeather = (field, value) => {
        setFormData(prev => ({
          ...prev,
          weather: { ...prev.weather, [field]: value }
        }));
      };

      const clearWeather = () => {
        setFormData(prev => ({
          ...prev,
          location: { latitude: null, longitude: null, city: '', state: '', display: '' },
          weather: { temperature: '', condition: 'sunny', humidity: '' }
        }));
        setAutoFetchStatus(prev => ({ ...prev, weather: { type: null, timestamp: null } }));
      };

      const clearPollen = () => {
        setFormData(prev => ({
          ...prev,
          pollen: {
            alder: 0, birch: 0, cypress: 0, elm: 0, hazel: 0,
            oak: 0, pine: 0, plane: 0, poplar: 0,
            grass: 0,
            mugwort: 0, ragweed: 0,
            mold: 0
          }
        }));
        setAutoFetchStatus(prev => ({ ...prev, pollen: { type: null, timestamp: null } }));
      };

      const getSeverityColor = (value) => {
        if (value === 0) return 'bg-gray-200';
        if (value === 1) return 'bg-green-200';
        if (value === 2) return 'bg-yellow-200';
        if (value === 3) return 'bg-orange-200';
        return 'bg-red-200';
      };

      const getSeverityLabel = (value) => {
        const labels = ['None', 'Mild', 'Moderate', 'Severe', 'Very Severe'];
        return labels[value] || 'None';
      };

      const formatFetchTime = (timestamp) => {
        if (!timestamp) return '';
        
        const now = new Date();
        const diffMs = now - timestamp;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        
        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return `${diffMins} min${diffMins === 1 ? '' : 's'} ago`;
        if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
        
        // For older data, show the actual time
        return timestamp.toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center min-h-screen">
            <div className="text-xl text-gray-600">Loading...</div>
          </div>
        );
      }

      // Show sign-in screen if Firebase is enabled but user not signed in
      if (firebaseEnabled && !user) {
        return (
          <div className="max-w-md mx-auto p-6 mt-20">
            <div className="bg-white rounded-2xl shadow-xl p-8">
              <div className="text-6xl mb-4 text-center">üå∏</div>
              <h1 className="text-3xl font-bold mb-2 text-center">Allergy Tracker</h1>
              <p className="text-gray-600 mb-6 text-center">
                {isSignUp ? 'Create an account to sync across devices' : 'Sign in to access your data'}
              </p>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                  <input
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="your@email.com"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    onKeyPress={(e) => e.key === 'Enter' && signInWithEmail()}
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                  <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    onKeyPress={(e) => e.key === 'Enter' && signInWithEmail()}
                  />
                </div>
                
                <button
                  onClick={signInWithEmail}
                  disabled={signingIn}
                  className="w-full bg-gradient-to-r from-blue-500 to-green-500 text-white font-bold py-3 px-6 rounded-lg hover:from-blue-600 hover:to-green-600 transition-all shadow-lg disabled:opacity-50"
                >
                  {signingIn ? '‚è≥ Please wait...' : (isSignUp ? '‚ú® Create Account' : 'üîê Sign In')}
                </button>
                
                <div className="text-center">
                  <button
                    onClick={() => setIsSignUp(!isSignUp)}
                    className="text-sm text-blue-600 hover:text-blue-700 underline"
                  >
                    {isSignUp ? 'Already have an account? Sign in' : "Don't have an account? Sign up"}
                  </button>
                </div>
              </div>
              
              <p className="text-xs text-gray-500 mt-6 text-center">‚ú® Your data syncs automatically across all devices</p>
              <p className="text-xs text-gray-500 mt-1 text-center">üîí Password must be at least 6 characters</p>
            </div>
          </div>
        );
      }

      return (
        <div className="max-w-4xl mx-auto p-6">
          <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
            {/* Header */}
            <div className="bg-gradient-to-r from-blue-500 to-green-500 p-6 text-white">
              <div className="flex justify-between items-start">
                <div>
                  <h1 className="text-3xl font-bold mb-2">üå∏ Allergy Symptom Tracker</h1>
                  <p className="text-blue-100">Track your symptoms with FREE automatic weather & pollen data</p>
                  {firebaseEnabled && user && (
                    <p className="text-blue-100 text-sm mt-1">‚ú® Signed in as {user.email} ‚Ä¢ <button onClick={signOut} className="underline hover:text-white">Sign Out</button></p>
                  )}
                  {!firebaseEnabled && (
                    <p className="text-yellow-200 text-sm mt-1">‚ö†Ô∏è Add Firebase config for cross-device sync</p>
                  )}
                </div>
                <button
                  onClick={() => setShowApiSetup(!showApiSetup)}
                  className="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm font-semibold transition-colors"
                >
                  ‚öôÔ∏è API Setup
                </button>
              </div>
            </div>

            {/* API Setup Panel */}
            {showApiSetup && (
              <div className="bg-blue-50 border-b border-blue-200 p-6">
                <h3 className="text-lg font-bold text-gray-800 mb-2">API Configuration (100% Free!)</h3>
                <p className="text-sm text-blue-700 mb-4">
                  üåü Keys are shared across all users ‚Ä¢ Data auto-fetches when you log entries
                </p>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Weather API Key (OpenWeatherMap) - FREE
                    </label>
                    <input
                      type="text"
                      value={apiKeys.weather}
                      onChange={(e) => setApiKeys(prev => ({ ...prev, weather: e.target.value }))}
                      placeholder="Enter your API key"
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                    <p className="text-xs text-gray-600 mt-1">
                      ‚úÖ Free: 1,000 calls/day | Get key at: <a href="https://openweathermap.org/api" target="_blank" className="text-blue-600 hover:underline">openweathermap.org/api</a>
                    </p>
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Pollen API Key (Google Pollen API) - FREE! üéâ
                    </label>
                    <input
                      type="text"
                      value={apiKeys.pollen}
                      onChange={(e) => setApiKeys(prev => ({ ...prev, pollen: e.target.value }))}
                      placeholder="Enter your Google API key"
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                    <div className="text-xs text-gray-600 mt-1 space-y-1">
                      <p className="font-semibold text-green-700">‚úÖ FREE: 5,000 calls/month (you'll use ~30/month!)</p>
                      <p>üìç Tree, grass, and weed pollen data</p>
                      <p>üåç Coverage in 65+ countries</p>
                      <p className="text-blue-600">üëâ Get your key at: <a href="https://console.cloud.google.com/apis/library/pollen.googleapis.com" target="_blank" className="text-blue-600 hover:underline">Google Cloud Console</a></p>
                    </div>
                  </div>

                  <div className="flex gap-3">
                    <button
                      onClick={saveApiKeys}
                      className="flex-1 bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors"
                    >
                      üíæ Save Keys
                    </button>
                    <button
                      onClick={() => setShowApiSetup(false)}
                      className="flex-1 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Navigation */}
            <div className="flex border-b">
              <button
                onClick={() => setView('log')}
                className={`flex-1 py-4 font-semibold transition-colors ${
                  view === 'log' 
                    ? 'bg-blue-50 text-blue-600 border-b-2 border-blue-600' 
                    : 'text-gray-600 hover:bg-gray-50'
                }`}
              >
                üìù Log Entry
              </button>
              <button
                onClick={() => setView('history')}
                className={`flex-1 py-4 font-semibold transition-colors ${
                  view === 'history' 
                    ? 'bg-blue-50 text-blue-600 border-b-2 border-blue-600' 
                    : 'text-gray-600 hover:bg-gray-50'
                }`}
              >
                üìä History ({entries.length})
              </button>
            </div>

            {/* Content */}
            <div className="p-6">
              {view === 'log' ? (
                <div className="space-y-6">
                  {/* Date */}
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                    <input
                      type="date"
                      value={formData.date}
                      onChange={(e) => setFormData(prev => ({ ...prev, date: e.target.value }))}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>

                  {/* Symptoms */}
                  <div>
                    <h3 className="text-lg font-bold text-gray-800 mb-3">Symptoms</h3>
                    <div className="space-y-4">
                      {Object.entries(formData.symptoms).map(([key, value]) => (
                        <div key={key}>
                          <div className="flex justify-between mb-1">
                            <label className="text-sm font-medium text-gray-700 capitalize">
                              {key.replace(/([A-Z])/g, ' $1').trim()}
                            </label>
                            <span className={`text-sm font-semibold px-3 py-1 rounded-full ${getSeverityColor(value)}`}>
                              {getSeverityLabel(value)}
                            </span>
                          </div>
                          <input
                            type="range"
                            min="0"
                            max="4"
                            value={value}
                            onChange={(e) => updateSymptom(key, e.target.value)}
                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                          />
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Weather */}
                  <div>
                    <div className="flex justify-between items-center mb-3">
                      <h3 className="text-lg font-bold text-gray-800">Weather</h3>
                      <div className="flex gap-2">
                        <button
                          onClick={fetchWeatherData}
                          disabled={fetchingWeather}
                          className={`px-4 py-2 rounded-lg font-semibold text-sm transition-colors ${
                            fetchingWeather 
                              ? 'bg-gray-300 text-gray-600 cursor-not-allowed' 
                              : 'bg-blue-500 text-white hover:bg-blue-600'
                          }`}
                        >
                          {fetchingWeather ? '‚è≥ Fetching...' : 'üå°Ô∏è Fetch'}
                        </button>
                        <button
                          onClick={clearWeather}
                          className="px-3 py-2 rounded-lg font-semibold text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors"
                        >
                          Clear
                        </button>
                      </div>
                    </div>
                    {!apiKeys.weather && (
                      <p className="text-xs text-orange-600 mb-2">
                        ‚ö†Ô∏è Add weather API key in "API Setup" to enable auto-fetch
                      </p>
                    )}
                    {autoFetchStatus.weather.type && (
                      <p className="text-xs text-green-600 mb-2">
                        ‚úì {autoFetchStatus.weather.type === 'auto' ? 'Auto-fetched' : 'Manually fetched'}
                        {' ‚Ä¢ '}
                        {formatFetchTime(autoFetchStatus.weather.timestamp)}
                        {formData.location.display && (
                          <>
                            {' ‚Ä¢ '}
                            üìç {formData.location.display}
                          </>
                        )}
                      </p>
                    )}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Temperature (¬∞F)</label>
                        <input
                          type="number"
                          value={formData.weather.temperature}
                          onChange={(e) => updateWeather('temperature', e.target.value)}
                          placeholder="72"
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Condition</label>
                        <select
                          value={formData.weather.condition}
                          onChange={(e) => updateWeather('condition', e.target.value)}
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                          <option value="sunny">‚òÄÔ∏è Sunny</option>
                          <option value="cloudy">‚òÅÔ∏è Cloudy</option>
                          <option value="rainy">üåßÔ∏è Rainy</option>
                          <option value="windy">üí® Windy</option>
                          <option value="snowy">‚ùÑÔ∏è Snowy</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Humidity (%)</label>
                        <input
                          type="number"
                          value={formData.weather.humidity}
                          onChange={(e) => updateWeather('humidity', e.target.value)}
                          placeholder="65"
                          min="0"
                          max="100"
                          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>
                    </div>
                  </div>

                  {/* Pollen */}
                  <div>
                    <div className="flex justify-between items-center mb-3">
                      <h3 className="text-lg font-bold text-gray-800">Pollen Levels</h3>
                      <div className="flex gap-2">
                        <button
                          onClick={fetchPollenData}
                          disabled={fetchingPollen || !apiKeys.pollen}
                          className={`px-4 py-2 rounded-lg font-semibold text-sm transition-colors ${
                            fetchingPollen || !apiKeys.pollen
                              ? 'bg-gray-300 text-gray-600 cursor-not-allowed' 
                              : 'bg-green-500 text-white hover:bg-green-600'
                          }`}
                        >
                          {fetchingPollen ? '‚è≥ Fetching...' : 'üåø Fetch'}
                        </button>
                        <button
                          onClick={clearPollen}
                          className="px-3 py-2 rounded-lg font-semibold text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors"
                        >
                          Clear
                        </button>
                      </div>
                    </div>
                    {!apiKeys.pollen && (
                      <p className="text-xs text-orange-600 mb-2">
                        ‚ö†Ô∏è Add Google Pollen API key in "API Setup" to enable auto-fetch (100% FREE!)
                      </p>
                    )}
                    {autoFetchStatus.pollen.type && (
                      <p className="text-xs text-green-600 mb-2">
                        ‚úì {autoFetchStatus.pollen.type === 'auto' ? 'Auto-fetched' : 'Manually fetched'}
                        {' ‚Ä¢ '}
                        {formatFetchTime(autoFetchStatus.pollen.timestamp)}
                        {formData.location.display && (
                          <>
                            {' ‚Ä¢ '}
                            üìç {formData.location.display}
                          </>
                        )}
                      </p>
                    )}
                    
                    {/* Tree Pollens */}
                    <div className="mb-4">
                      <h4 className="text-sm font-semibold text-gray-700 mb-2">üå≥ Tree Pollen</h4>
                      <div className="space-y-3 ml-2">
                        {['alder', 'birch', 'cypress', 'elm', 'hazel', 'oak', 'pine', 'plane', 'poplar'].map(key => (
                          <div key={key}>
                            <div className="flex justify-between mb-1">
                              <label className="text-xs font-medium text-gray-600 capitalize">{key}</label>
                              <span className={`text-xs font-semibold px-2 py-0.5 rounded-full ${getSeverityColor(formData.pollen[key])}`}>
                                {getSeverityLabel(formData.pollen[key])}
                              </span>
                            </div>
                            <input
                              type="range"
                              min="0"
                              max="4"
                              value={formData.pollen[key]}
                              onChange={(e) => updatePollen(key, e.target.value)}
                              className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                            />
                          </div>
                        ))}
                      </div>
                    </div>
                    
                    {/* Grass Pollen */}
                    <div className="mb-4">
                      <h4 className="text-sm font-semibold text-gray-700 mb-2">üåæ Grass Pollen</h4>
                      <div className="ml-2">
                        <div>
                          <div className="flex justify-between mb-1">
                            <label className="text-xs font-medium text-gray-600">Grass</label>
                            <span className={`text-xs font-semibold px-2 py-0.5 rounded-full ${getSeverityColor(formData.pollen.grass)}`}>
                              {getSeverityLabel(formData.pollen.grass)}
                            </span>
                          </div>
                          <input
                            type="range"
                            min="0"
                            max="4"
                            value={formData.pollen.grass}
                            onChange={(e) => updatePollen('grass', e.target.value)}
                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                          />
                        </div>
                      </div>
                    </div>
                    
                    {/* Weed Pollens */}
                    <div className="mb-4">
                      <h4 className="text-sm font-semibold text-gray-700 mb-2">üåø Weed Pollen</h4>
                      <div className="space-y-3 ml-2">
                        {['mugwort', 'ragweed'].map(key => (
                          <div key={key}>
                            <div className="flex justify-between mb-1">
                              <label className="text-xs font-medium text-gray-600 capitalize">{key}</label>
                              <span className={`text-xs font-semibold px-2 py-0.5 rounded-full ${getSeverityColor(formData.pollen[key])}`}>
                                {getSeverityLabel(formData.pollen[key])}
                              </span>
                            </div>
                            <input
                              type="range"
                              min="0"
                              max="4"
                              value={formData.pollen[key]}
                              onChange={(e) => updatePollen(key, e.target.value)}
                              className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                            />
                          </div>
                        ))}
                      </div>
                    </div>
                    
                    {/* Other */}
                    <div>
                      <h4 className="text-sm font-semibold text-gray-700 mb-2">üçÑ Other</h4>
                      <div className="ml-2">
                        <div>
                          <div className="flex justify-between mb-1">
                            <label className="text-xs font-medium text-gray-600">Mold (Manual only)</label>
                            <span className={`text-xs font-semibold px-2 py-0.5 rounded-full ${getSeverityColor(formData.pollen.mold)}`}>
                              {getSeverityLabel(formData.pollen.mold)}
                            </span>
                          </div>
                          <input
                            type="range"
                            min="0"
                            max="4"
                            value={formData.pollen.mold}
                            onChange={(e) => updatePollen('mold', e.target.value)}
                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                          />
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Notes */}
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
                    <textarea
                      value={formData.notes}
                      onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
                      placeholder="Any additional observations..."
                      rows="3"
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>

                  {/* Save Button */}
                  <button
                    onClick={saveEntry}
                    className="w-full bg-gradient-to-r from-blue-500 to-green-500 text-white font-bold py-3 px-6 rounded-lg hover:from-blue-600 hover:to-green-600 transition-all shadow-lg"
                  >
                    üíæ Save Entry
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  {entries.length === 0 ? (
                    <div className="text-center py-12">
                      <p className="text-gray-500 text-lg mb-4">No entries yet</p>
                      <button
                        onClick={() => setView('log')}
                        className="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors"
                      >
                        Create First Entry
                      </button>
                    </div>
                  ) : (
                    entries.map(entry => (
                      <div key={entry.id} className="bg-gray-50 rounded-lg p-5 border border-gray-200">
                        <div className="flex justify-between items-start mb-4">
                          <div>
                            <h4 className="font-bold text-lg text-gray-800">
                              {(() => {
                                // Parse date string directly to avoid timezone issues
                                const [year, month, day] = entry.date.split('-');
                                const date = new Date(year, month - 1, day);
                                return date.toLocaleDateString('en-US', { 
                                  weekday: 'long', 
                                  year: 'numeric', 
                                  month: 'long', 
                                  day: 'numeric' 
                                });
                              })()}
                            </h4>
                            {entry.location && entry.location.display && (
                              <div className="text-sm text-gray-600 mt-1">
                                üìç {entry.location.display}
                              </div>
                            )}
                            {(entry.weather.temperature || entry.weather.condition || entry.weather.humidity) && (
                              <div className="text-sm text-gray-600 mt-1">
                                {entry.weather.temperature && `${entry.weather.temperature}¬∞F`}
                                {entry.weather.temperature && entry.weather.condition && ' ‚Ä¢ '}
                                {entry.weather.condition && entry.weather.condition.charAt(0).toUpperCase() + entry.weather.condition.slice(1)}
                                {entry.weather.humidity && ` ‚Ä¢ ${entry.weather.humidity}% humidity`}
                              </div>
                            )}
                          </div>
                          <button
                            onClick={() => deleteEntry(entry.id)}
                            className="text-red-500 hover:text-red-700 font-semibold text-sm"
                          >
                            üóëÔ∏è Delete
                          </button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <h5 className="font-semibold text-gray-700 mb-2 text-sm">Symptoms</h5>
                            <div className="space-y-1">
                              {Object.entries(entry.symptoms).map(([key, value]) => (
                                <div key={key} className="flex justify-between text-sm">
                                  <span className="capitalize text-gray-600">
                                    {key.replace(/([A-Z])/g, ' $1').trim()}
                                  </span>
                                  <span className={`font-semibold px-2 py-0.5 rounded ${getSeverityColor(value)}`}>
                                    {getSeverityLabel(value)}
                                  </span>
                                </div>
                              ))}
                            </div>
                          </div>

                          <div>
                            <h5 className="font-semibold text-gray-700 mb-2 text-sm">Pollen Levels</h5>
                            <div className="space-y-1">
                              {Object.entries(entry.pollen).map(([key, value]) => (
                                <div key={key} className="flex justify-between text-sm">
                                  <span className="capitalize text-gray-600">{key}</span>
                                  <span className={`font-semibold px-2 py-0.5 rounded ${getSeverityColor(value)}`}>
                                    {getSeverityLabel(value)}
                                  </span>
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>

                        {entry.notes && (
                          <div className="mt-3 pt-3 border-t border-gray-300">
                            <p className="text-sm text-gray-700 italic">"{entry.notes}"</p>
                          </div>
                        )}
                      </div>
                    ))
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<AllergyTracker />, document.getElementById('root'));
  </script>
</body>
</html>